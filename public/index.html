<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReddiLite</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #DAE0E6; }
        .post-card { border: 1px solid #ccc; background: white; margin-bottom: 10px; border-radius: 5px; }
        .vote-section { background-color: #f8f9fa; width: 40px; text-align: center; border-right: 1px solid #eee; border-radius: 5px 0 0 5px; padding-top: 10px; }
        .post-content { padding: 10px; }
        .comment-section { margin-left: 20px; border-left: 2px solid #ccc; padding-left: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background-color: #ff4500;">
  <div class="container">
    <a class="navbar-brand" href="#">ReddiLite</a>
    <div class="d-flex" id="auth-buttons">
        <!-- Filled by JS -->
    </div>
  </div>
</nav>

<div class="container">
    
    <!-- Login / Register Modals -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="loginUsername" class="form-control mb-2" placeholder="Username">
                    <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Password">
                    <button onclick="login()" class="btn btn-primary w-100">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Sign Up</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="regUsername" class="form-control mb-2" placeholder="Username">
                    <input type="password" id="regPassword" class="form-control mb-2" placeholder="Password">
                    <button onclick="register()" class="btn btn-success w-100">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Post Form (Visible only when logged in) -->
    <div id="new-post-section" class="card p-3 mb-4 d-none">
        <h4>Create Post</h4>
        <input type="text" id="postTitle" class="form-control mb-2" placeholder="Title">
        <textarea id="postText" class="form-control mb-2" placeholder="What are you thinking?"></textarea>
        <input type="text" id="postCommunity" class="form-control mb-2" placeholder="Community (e.g. technology)">
        <button onclick="createPost()" class="btn text-white" style="background-color: #ff4500;">Post</button>
    </div>

    <!-- Post List -->
    <div id="posts-container">
        <!-- Posts will be loaded here -->
        <div class="text-center mt-5"><div class="spinner-border" role="status"></div></div>
    </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = 'http://localhost:3000/api';
    let token = localStorage.getItem('token');
    let currentUser = localStorage.getItem('username');

    // On Page Load
    document.addEventListener('DOMContentLoaded', () => {
        updateAuthUI();
        loadPosts();
    });

    function updateAuthUI() {
        const authDiv = document.getElementById('auth-buttons');
        const postSection = document.getElementById('new-post-section');

        if (token) {
            authDiv.innerHTML = `
                <span class="navbar-text me-3">Hello, <b>${currentUser}</b></span>
                <button onclick="logout()" class="btn btn-outline-light btn-sm">Logout</button>
            `;
            postSection.classList.remove('d-none');
        } else {
            authDiv.innerHTML = `
                <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#registerModal">Sign Up</button>
            `;
            postSection.classList.add('d-none');
        }
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        const res = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        
        if (res.ok) {
            token = data.token;
            currentUser = username;
            localStorage.setItem('token', token);
            localStorage.setItem('username', username);
            location.reload();
        } else {
            alert(data.error);
        }
    }

    async function register() {
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        
        const res = await fetch(`${API_URL}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        if (res.ok) {
            alert('Registration successful! You can now login.');
            location.reload();
        } else {
            alert('An error occurred.');
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        location.reload();
    }

    async function loadPosts() {
        const res = await fetch(`${API_URL}/messages`);
        const posts = await res.json();
        
        const container = document.getElementById('posts-container');
        container.innerHTML = '';

        posts.forEach(post => {
            const upCount = post.upvotes ? post.upvotes.length : 0;
            const downCount = post.downvotes ? post.downvotes.length : 0;
            const score = upCount - downCount;

            const postHTML = `
                <div class="d-flex post-card">
                    <div class="vote-section">
                        <div onclick="vote('${post._id}', 'up')" style="cursor:pointer">â–²</div>
                        <div class="fw-bold">${score}</div>
                        <div onclick="vote('${post._id}', 'down')" style="cursor:pointer">â–¼</div>
                    </div>
                    <div class="post-content w-100">
                        <small class="text-muted">r/${post.community} â€¢ Posted by: ${post.author}</small>
                        <h5 class="mt-1">${post.title}</h5>
                        <p>${post.text}</p>
                        
                        <div class="d-flex gap-2">
                            <button onclick="toggleComments('${post._id}')" class="btn btn-sm btn-light">ðŸ’¬ Comments</button>
                        </div>

                        <!-- Comments Section (Hidden) -->
                        <div id="comments-${post._id}" class="d-none mt-3">
                            <div id="comments-list-${post._id}">Loading...</div>
                            ${token ? `
                                <div class="input-group mt-2">
                                    <input type="text" id="comment-input-${post._id}" class="form-control form-control-sm" placeholder="Write a comment...">
                                    <button onclick="addComment('${post._id}')" class="btn btn-sm btn-secondary">Submit</button>
                                </div>
                            ` : '<small class="text-danger">Log in to comment.</small>'}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += postHTML;
        });
    }

    async function createPost() {
        const title = document.getElementById('postTitle').value;
        const text = document.getElementById('postText').value;
        const community = document.getElementById('postCommunity').value;

        const res = await fetch(`${API_URL}/messages`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token  
            },
            body: JSON.stringify({ title, text, community })
        });

        if (res.ok) {
            document.getElementById('postTitle').value = '';
            document.getElementById('postText').value = '';
            loadPosts();
        } else {
            alert('An error occurred.');
        }
    }

    async function vote(id, type) {
        if (!token) return alert('You must be logged in to vote!');

        await fetch(`${API_URL}/messages/${id}/vote`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token  
            },
            body: JSON.stringify({ type })
        });
        loadPosts(); // Refresh list
    }

    async function toggleComments(postId) {
        const section = document.getElementById(`comments-${postId}`);
        if (section.classList.contains('d-none')) {
            section.classList.remove('d-none');
            loadComments(postId);
        } else {
            section.classList.add('d-none');
        }
    }

    async function loadComments(postId) {
        const res = await fetch(`${API_URL}/messages/${postId}/comments`);
        const comments = await res.json();
        
        const listDiv = document.getElementById(`comments-list-${postId}`);
        if (comments.length === 0) {
            listDiv.innerHTML = '<small class="text-muted">No comments yet.</small>';
            return;
        }

        listDiv.innerHTML = comments.map(c => `
            <div class="comment-section">
                <small><b>${c.author}</b> says:</small>
                <p class="mb-1">${c.text}</p>
            </div>
        `).join('');
    }

    async function addComment(postId) {
        const input = document.getElementById(`comment-input-${postId}`);
        const text = input.value;
        if (!text) return;

        await fetch(`${API_URL}/messages/${postId}/comments`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token  
            },
            body: JSON.stringify({ text })
        });
        
        input.value = '';
        loadComments(postId);
    }
</script>

</body>
</html>
